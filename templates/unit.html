{% extends "base.html" %}

{% block title %}{{ unit.name }} - {{ level.name_ar }} - {{ track.name_ar }}{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{{ url_for('home') }}">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <span class="breadcrumb-sep">â€¹</span>
    <a href="{{ url_for('track', track_id=track.id) }}">{{ track.icon }} {{ track.name_ar }}</a>
    <span class="breadcrumb-sep">â€¹</span>
    <a href="{{ url_for('level', track_id=track.id, level_id=level.id) }}">{{ level.icon }} {{ level.name_ar }}</a>
    <span class="breadcrumb-sep">â€¹</span>
    <span class="breadcrumb-current">{{ unit.name }}</span>
</div>
{% endblock %}

{% block content %}
<section class="unit-hero" style="--track-color: {{ track.color }}">
    <div class="unit-hero-content">
        <div class="unit-hero-badge">{{ track.icon }} {{ track.name_ar }} â€¢ {{ level.icon }} {{ level.name_ar }}</div>

        <h1>
            <span class="editable-field" data-api-url="/api/unit/{{ track.id }}/{{ level.id }}/{{ unit.id }}" data-field-name="name">
                <span class="editable-text">{{ unit.name }}</span>
                <button class="edit-btn" onclick="startInlineEdit(this)">âœï¸</button>
            </span>
        </h1>

        <p class="unit-hero-en">
            <span class="editable-field" data-api-url="/api/unit/{{ track.id }}/{{ level.id }}/{{ unit.id }}" data-field-name="name_en">
                <span class="editable-text">{{ unit.name_en }}</span>
                <button class="edit-btn" onclick="startInlineEdit(this)">âœï¸</button>
            </span>
        </p>

        <p class="unit-hero-desc">
            <span class="editable-field" data-api-url="/api/unit/{{ track.id }}/{{ level.id }}/{{ unit.id }}" data-field-name="description">
                <span class="editable-text">{{ unit.description }}</span>
                <button class="edit-btn" onclick="startInlineEdit(this)">âœï¸</button>
            </span>
        </p>

        <div class="section-actions">
            <button class="delete-btn" onclick="deleteUnit('{{ track.id }}', '{{ level.id }}', '{{ unit.id }}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©</button>
        </div>
    </div>
</section>

<div class="unit-content-wrapper">
    <section class="objectives-section animate-on-scroll">
        <h2 class="section-title">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„Ù…</h2>
        <div class="objectives-list">
            {% for obj in unit.objectives %}
            {% set bloom_colors = {
                'ØªØ°ÙƒØ±': '#74B9FF',
                'ÙÙ‡Ù…': '#55EFC4',
                'ØªØ·Ø¨ÙŠÙ‚': '#FFEAA7',
                'ØªØ­Ù„ÙŠÙ„': '#FD79A8',
                'ØªÙ‚ÙŠÙŠÙ…': '#E17055',
                'Ø§Ø¨ØªÙƒØ§Ø±': '#A29BFE'
            } %}
            <div class="objective-card" style="--bloom-color: {{ bloom_colors.get(obj.bloom, '#74B9FF') }}"
                 data-obj-id="{{ obj.id }}"
                 data-obj-bloom="{{ obj.bloom }}"
                 data-obj-objective="{{ obj.objective }}"
                 data-obj-outcome="{{ obj.outcome }}">
                <div class="objective-header">
                    <span class="bloom-badge" style="background-color: {{ bloom_colors.get(obj.bloom, '#74B9FF') }}">
                        {{ obj.bloom }}
                        <span class="bloom-en">{{ obj.bloom_en }}</span>
                    </span>
                    <button class="edit-btn obj-edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="delete-btn obj-delete-btn" style="padding: 4px 10px; font-size: 0.8rem;">ğŸ—‘ï¸</button>
                </div>
                <div class="objective-body">
                    <div class="objective-text">
                        <h4>ğŸ¯ Ø§Ù„Ù‡Ø¯Ù</h4>
                        <p>{{ obj.objective }}</p>
                    </div>
                    <div class="outcome-text">
                        <h4>âœ… Ø§Ù„Ù…Ø®Ø±Ø¬</h4>
                        <p>{{ obj.outcome }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="section-actions">
            <button class="add-btn" onclick="addObjective('{{ track.id }}', '{{ level.id }}', '{{ unit.id }}')">â• Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù</button>
        </div>
    </section>

    <section class="project-section animate-on-scroll">
        <h2 class="section-title">ğŸ—ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
        <div class="project-card" style="--track-color: {{ track.color }}">
            <div class="project-icon">ğŸš€</div>
            <h3>
                <span class="editable-field" data-api-url="/api/unit/{{ track.id }}/{{ level.id }}/{{ unit.id }}" data-field-name="project_name">
                    <span class="editable-text">{{ unit.project.name }}</span>
                    <button class="edit-btn" onclick="startInlineEdit(this)">âœï¸</button>
                </span>
            </h3>
            <p>
                <span class="editable-field" data-api-url="/api/unit/{{ track.id }}/{{ level.id }}/{{ unit.id }}" data-field-name="project_description">
                    <span class="editable-text">{{ unit.project.description }}</span>
                    <button class="edit-btn" onclick="startInlineEdit(this)">âœï¸</button>
                </span>
            </p>
        </div>
    </section>

    <section class="skills-section animate-on-scroll">
        <h2 class="section-title">ğŸ’¡ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</h2>
        <div class="skills-grid">
            {% for skill in unit.skills_raw %}
            <div class="skill-card" style="--track-color: {{ track.color }}" data-skill-id="{{ skill.id }}">
                <span class="skill-icon">â­</span>
                <span>{{ skill.name }}</span>
                <button class="delete-btn skill-delete-btn" style="padding: 2px 8px; font-size: 0.75rem; margin-right: auto;">âœ•</button>
            </div>
            {% endfor %}
        </div>
        <div class="section-actions">
            <button class="add-btn" onclick="addSkill('{{ track.id }}', '{{ level.id }}', '{{ unit.id }}')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø©</button>
        </div>
    </section>

    <div class="unit-navigation">
        {% set unit_index = level.units.index(unit) if unit in level.units else -1 %}
        {% if unit_index == -1 %}
            {% for u in level.units %}
                {% if u.id == unit.id %}
                    {% set unit_index = loop.index0 %}
                {% endif %}
            {% endfor %}
        {% endif %}

        {% set ns = namespace(idx=-1) %}
        {% for u in level.units %}
            {% if u.id == unit.id %}
                {% set ns.idx = loop.index0 %}
            {% endif %}
        {% endfor %}

        {% if ns.idx > 0 %}
        <a href="{{ url_for('unit', track_id=track.id, level_id=level.id, unit_id=level.units[ns.idx - 1].id) }}" class="nav-btn nav-prev" style="--track-color: {{ track.color }}">
            â†’ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        </a>
        {% else %}
        <div></div>
        {% endif %}

        {% if ns.idx >= 0 and ns.idx < level.units|length - 1 %}
        <a href="{{ url_for('unit', track_id=track.id, level_id=level.id, unit_id=level.units[ns.idx + 1].id) }}" class="nav-btn nav-next" style="--track-color: {{ track.color }}">
            Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â†
        </a>
        {% else %}
        <div></div>
        {% endif %}
    </div>
</div>
{% endblock %}
