{% extends "base_dashboard.html" %}

{% block page_title %}{{ student.name_ar|default('Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨') }} - Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teacher.css') }}">
{% endblock %}

{% block sidebar_nav %}
<a href="{{ url_for('teacher.dashboard') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ </span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="{{ url_for('teacher.groups') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ‘¥</span>
    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.sessions') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ“…</span>
    <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.homework') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ“</span>
    <span>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span>
</a>
{% endblock %}

{% block topbar_title %}Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨{% endblock %}

{% block topbar_actions %}
<button class="btn btn-sm btn-ghost" onclick="history.back()">
    â† Ø±Ø¬ÙˆØ¹
</button>
{% endblock %}

{% block content %}
<!-- Student Profile Header -->
<div class="card" style="margin-bottom: var(--space-xl); padding: var(--space-xl);">
    <div style="display: flex; align-items: center; gap: var(--space-xl); flex-wrap: wrap;">
        <div class="avatar avatar-xl" style="flex-shrink: 0;">
            {% if student.avatar_url %}
            <img src="{{ student.avatar_url }}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
            {% else %}
            {{ student.name_ar[0] if student.name_ar else '?' }}
            {% endif %}
        </div>
        <div style="flex: 1;">
            <h2 style="font-size: var(--text-2xl); font-weight: 800; margin-bottom: var(--space-xs);">{{ student.name_ar }}</h2>
            {% if student.name_en %}
            <div class="text-muted" style="margin-bottom: var(--space-sm);">{{ student.name_en }}</div>
            {% endif %}
            <div style="display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
                <span class="badge badge-purple">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ level|default(1) }}</span>
                <span class="badge badge-orange">{{ total_xp|default(0) }} XP</span>
                {% if student.email %}
                <span class="text-sm text-muted">{{ student.email }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-purple-glow); color: var(--sv-purple);">âš¡</div>
        <div>
            <div class="stat-value">{{ total_xp|default(0) }}</div>
            <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-orange-glow); color: var(--sv-orange);">ğŸ¯</div>
        <div>
            <div class="stat-value">{{ level|default(1) }}</div>
            <div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--success-light); color: var(--success);">ğŸ‘¥</div>
        <div>
            <div class="stat-value">{{ student.group_memberships.count() }}</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--info-light); color: var(--info);">ğŸ…</div>
        <div>
            <div class="stat-value">{{ student.badges_earned.count() }}</div>
            <div class="stat-label">Ø§Ù„Ø´Ø§Ø±Ø§Øª</div>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-grid-main">
        <!-- Attendance Records -->
        <div class="card" style="margin-bottom: var(--space-xl);">
            <div class="card-header">
                <h2 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
            </div>

            {% set att_records = student.attendance_records.order_by(None).limit(20).all() %}
            {% if att_records %}
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¬Ù„Ø³Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                            <th>Ø§Ù„Ù…Ø¯Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for att in att_records %}
                        <tr>
                            <td>
                                {% if att.session %}
                                <a href="{{ url_for('teacher.session_detail', session_id=att.session.id) }}" style="font-weight: 700; color: var(--sv-purple); text-decoration: none;">
                                    {{ att.session.title }}
                                </a>
                                {% else %}
                                <span class="text-muted">--</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if att.status.value == 'present' %}
                                    <span class="badge badge-success">Ø­Ø§Ø¶Ø±</span>
                                {% elif att.status.value == 'absent' %}
                                    <span class="badge badge-danger">ØºØ§Ø¦Ø¨</span>
                                {% elif att.status.value == 'late' %}
                                    <span class="badge badge-warning">Ù…ØªØ£Ø®Ø±</span>
                                {% elif att.status.value == 'excused' %}
                                    <span class="badge badge-info">Ù…Ø¹ØªØ°Ø±</span>
                                {% endif %}
                            </td>
                            <td class="text-sm text-muted">{{ att.joined_at|default('--', true) }}</td>
                            <td class="text-sm">
                                {% if att.duration_seconds %}
                                    {{ (att.duration_seconds // 60) }} Ø¯Ù‚ÙŠÙ‚Ø©
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±</div>
            </div>
            {% endif %}
        </div>

        <!-- Homework Submissions -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ØªØ³Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</h2>
            </div>

            {% set hw_subs = student.homework_submissions.limit(20).all() %}
            {% if hw_subs %}
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙˆØ§Ø¬Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                            <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in hw_subs %}
                        <tr>
                            <td style="font-weight: 700;">{{ sub.homework.title if sub.homework else '--' }}</td>
                            <td class="text-sm text-muted">{{ sub.submitted_at|default('', true) }}</td>
                            <td>
                                {% if sub.grade is not none %}
                                    {% if sub.grade >= 90 %}
                                        <span class="badge badge-success">{{ sub.grade }} / 100</span>
                                    {% elif sub.grade >= 70 %}
                                        <span class="badge badge-info">{{ sub.grade }} / 100</span>
                                    {% elif sub.grade >= 50 %}
                                        <span class="badge badge-warning">{{ sub.grade }} / 100</span>
                                    {% else %}
                                        <span class="badge badge-danger">{{ sub.grade }} / 100</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-warning">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                                {% endif %}
                            </td>
                            <td class="text-sm text-muted">{{ sub.feedback|default('--', true) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ù„ÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Student Sidebar -->
    <div class="dashboard-grid-aside">
        <!-- Student Info -->
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                    <div style="font-weight: 700;">{{ student.name_ar }}</div>
                </div>
                {% if student.name_en %}
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div>
                    <div style="font-weight: 700;">{{ student.name_en }}</div>
                </div>
                {% endif %}
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                    <div style="font-weight: 700; font-size: var(--text-sm);">{{ student.email }}</div>
                </div>
                {% if student.phone %}
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ù‡Ø§ØªÙ</div>
                    <div style="font-weight: 700;">{{ student.phone }}</div>
                </div>
                {% endif %}
                <div>
                    <div class="text-muted text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
                    <div style="font-weight: 700; font-size: var(--text-sm);">{{ student.created_at|default('', true) }}</div>
                </div>
            </div>
        </div>

        <!-- Groups -->
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h3>
            {% set memberships = student.group_memberships.all() %}
            {% if memberships %}
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                {% for gm in memberships %}
                <a href="{{ url_for('teacher.group_detail', group_id=gm.group.id) }}" style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); border-radius: var(--radius-sm); text-decoration: none; color: var(--text-primary); background: var(--bg);">
                    <span style="color: var(--sv-purple);">ğŸ‘¥</span>
                    <div>
                        <div style="font-weight: 700; font-size: var(--text-sm);">{{ gm.group.name }}</div>
                        <div class="text-muted" style="font-size: var(--text-xs);">{{ gm.group.track_id|default('', true) }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</p>
            {% endif %}
        </div>

        <!-- Badges -->
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">Ø§Ù„Ø´Ø§Ø±Ø§Øª</h3>
            {% set badges_list = student.badges_earned.all() %}
            {% if badges_list %}
            <div style="display: flex; flex-wrap: wrap; gap: var(--space-sm);">
                {% for badge in badges_list %}
                <div style="display: flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-sm); background: var(--sv-purple-glow); border-radius: var(--radius-full);" title="{{ badge.description_ar|default(badge.description, true) }}">
                    <span>{{ badge.icon|default('ğŸ…', true) }}</span>
                    <span style="font-size: var(--text-xs); font-weight: 700; color: var(--sv-purple);">{{ badge.name_ar|default(badge.name, true) }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-sm">Ù„Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>
            {% endif %}
        </div>

        <!-- XP Progress -->
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">ØªÙ‚Ø¯Ù… Ø§Ù„Ø®Ø¨Ø±Ø©</h3>
            <div style="text-align: center; margin-bottom: var(--space-md);">
                <div style="font-size: var(--text-3xl); font-weight: 800; color: var(--sv-purple);">{{ total_xp|default(0) }}</div>
                <div class="text-muted text-sm">Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                <span class="text-sm">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ level|default(1) }}</span>
                <span class="text-sm text-muted">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ (level|default(1)) + 1 }}</span>
            </div>
            <div class="progress progress-lg">
                <div class="progress-bar" style="width: {{ ((total_xp|default(0)) % 500) / 5 }}%;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
