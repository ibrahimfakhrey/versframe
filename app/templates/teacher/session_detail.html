{% extends "base_dashboard.html" %}

{% block page_title %}{{ session.title|default('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©') }} - Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teacher.css') }}">
{% endblock %}

{% block sidebar_nav %}
<a href="{{ url_for('teacher.dashboard') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ </span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="{{ url_for('teacher.groups') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ‘¥</span>
    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.sessions') }}" class="sidebar-link active">
    <span class="sidebar-icon">ğŸ“…</span>
    <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.homework') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ“</span>
    <span>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span>
</a>
{% endblock %}

{% block topbar_title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('teacher.sessions') }}" class="btn btn-sm btn-ghost">
    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¬Ù„Ø³Ø§Øª
</a>
{% if session.status.value == 'scheduled' %}
<form action="{{ url_for('teacher.session_start', session_id=session.id) }}" method="POST" style="display:inline;margin:0;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-sm btn-orange">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
</form>
{% elif session.status.value == 'live' %}
<a href="{{ url_for('room.room', session_id=session.id) }}" class="btn btn-sm btn-orange">
    Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©
</a>
<form action="{{ url_for('teacher.session_end', session_id=session.id) }}" method="POST" style="display:inline;margin:0;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
</form>
{% endif %}
{% endblock %}

{% block content %}
<!-- Session Info Stats -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-purple-glow); color: var(--sv-purple);">ğŸ“…</div>
        <div>
            <div class="stat-value text-sm" style="font-size: var(--text-base);">{{ session.scheduled_at|default('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', true) }}</div>
            <div class="stat-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-orange-glow); color: var(--sv-orange);">ğŸ•</div>
        <div>
            <div class="stat-value">{{ session.duration_minutes|default(60) }}</div>
            <div class="stat-label">Ø¯Ù‚ÙŠÙ‚Ø©</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--info-light); color: var(--info);">ğŸ‘¥</div>
        <div>
            <div class="stat-value">{{ session.attendance.count() }}</div>
            <div class="stat-label">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background:
            {% if session.status.value == 'scheduled' %}var(--info-light){% elif session.status.value == 'live' %}var(--sv-orange-glow){% elif session.status.value == 'completed' %}var(--success-light){% else %}var(--danger-light){% endif %};
            color:
            {% if session.status.value == 'scheduled' %}var(--info){% elif session.status.value == 'live' %}var(--sv-orange){% elif session.status.value == 'completed' %}var(--success){% else %}var(--danger){% endif %};">
            {% if session.status.value == 'scheduled' %}ğŸ•{% elif session.status.value == 'live' %}ğŸ”´{% elif session.status.value == 'completed' %}âœ…{% else %}âŒ{% endif %}
        </div>
        <div>
            <div class="stat-value text-sm" style="font-size: var(--text-base);">
                {% if session.status.value == 'scheduled' %}Ù…Ø¬Ø¯ÙˆÙ„Ø©{% elif session.status.value == 'live' %}Ù…Ø¨Ø§Ø´Ø±Ø©{% elif session.status.value == 'completed' %}Ù…ÙƒØªÙ…Ù„Ø©{% elif session.status.value == 'cancelled' %}Ù…Ù„ØºÙŠØ©{% endif %}
            </div>
            <div class="stat-label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-grid-main">
        <!-- Attendance Table -->
        <div class="card" style="margin-bottom: var(--space-xl);">
            <div class="card-header">
                <h2 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
            </div>

            {% set attendance_list = session.attendance.all() %}
            {% if attendance_list %}
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                            <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                            <th>Ù…Ø¯Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for att in attendance_list %}
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <div class="avatar avatar-sm">
                                        {% if att.student.avatar_url %}
                                        <img src="{{ att.student.avatar_url }}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                                        {% else %}
                                        {{ att.student.name_ar[0] if att.student.name_ar else '?' }}
                                        {% endif %}
                                    </div>
                                    <a href="{{ url_for('teacher.student_profile', student_id=att.student.id) }}" style="font-weight: 700; color: var(--text-primary); text-decoration: none;">
                                        {{ att.student.name_ar }}
                                    </a>
                                </div>
                            </td>
                            <td>
                                {% if att.status.value == 'present' %}
                                    <span class="badge badge-success">Ø­Ø§Ø¶Ø±</span>
                                {% elif att.status.value == 'absent' %}
                                    <span class="badge badge-danger">ØºØ§Ø¦Ø¨</span>
                                {% elif att.status.value == 'late' %}
                                    <span class="badge badge-warning">Ù…ØªØ£Ø®Ø±</span>
                                {% elif att.status.value == 'excused' %}
                                    <span class="badge badge-info">Ù…Ø¹ØªØ°Ø±</span>
                                {% endif %}
                            </td>
                            <td class="text-sm text-muted">{{ att.joined_at|default('--', true) }}</td>
                            <td class="text-sm text-muted">{{ att.left_at|default('--', true) }}</td>
                            <td class="text-sm">
                                {% if att.duration_seconds %}
                                    {{ (att.duration_seconds // 60) }} Ø¯Ù‚ÙŠÙ‚Ø©
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯</div>
                <p class="text-muted text-sm">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</p>
            </div>
            {% endif %}
        </div>

        <!-- Session Resources -->
        <div class="card" style="margin-bottom: var(--space-xl);">
            <div class="card-header">
                <h2 class="card-title">Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            </div>

            {% set resources_list = session.resources.all() %}
            {% if resources_list %}
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                {% for sr in resources_list %}
                <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-md); background: var(--bg); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: var(--space-sm);">
                        <span style="font-size: 1.25rem;">
                            {% if sr.resource.type.value == 'slides' %}ğŸ“Š
                            {% elif sr.resource.type.value == 'code_exercise' %}ğŸ’»
                            {% elif sr.resource.type.value == 'qna' %}â“
                            {% elif sr.resource.type.value == 'whiteboard' %}ğŸ¨
                            {% else %}ğŸ“„{% endif %}
                        </span>
                        <div>
                            <div style="font-weight: 700; font-size: var(--text-sm);">{{ sr.resource.name_ar|default(sr.resource.name, true) }}</div>
                            <div class="text-muted text-sm">{{ sr.resource.type.value }}</div>
                        </div>
                    </div>
                    {% if sr.is_active %}
                    <span class="badge badge-success">Ù†Ø´Ø·</span>
                    {% else %}
                    <span class="badge badge-info">Ø¬Ø§Ù‡Ø²</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“¦</div>
                <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø±Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
            </div>
            {% endif %}
        </div>

        {% if session.status.value == 'live' %}
        <!-- End Session Card -->
        <div class="card" style="margin-bottom: var(--space-xl); border: 2px solid var(--danger);">
            <div class="card-header">
                <h2 class="card-title" style="color: var(--danger);">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            </div>
            <div style="padding: var(--space-lg);">
                <p class="text-sm text-muted" style="margin-bottom: var(--space-md);">Ø³ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆÙ…Ù†Ø­ Ù†Ù‚Ø§Ø· XP Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†.</p>
                <form action="{{ url_for('teacher.session_end', session_id=session.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ Ø³ÙŠØªÙ… Ù…Ù†Ø­ 50 XP Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø­Ø§Ø¶Ø±.')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù†</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Session Report Form -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            </div>

            <form action="{{ url_for('teacher.session_report', session_id=session.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label class="form-label" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                    <textarea
                        class="form-textarea"
                        id="notes"
                        name="notes"
                        rows="5"
                        placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¹Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ù‡Ù†Ø§..."
                    >{{ session.teacher_notes|default('', true) }}</textarea>
                    <div class="form-hint">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„ØªÙŠ ØªÙ…Øª ØªØºØ·ÙŠØªÙ‡Ø§</div>
                </div>

                <div style="display: flex; gap: var(--space-sm);">
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="dashboard-grid-aside">
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                <div>
                    <div class="text-muted text-sm">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù„Ø³Ø©</div>
                    <div style="font-weight: 700;">{{ session.title }}</div>
                </div>
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
                    <div style="font-weight: 700;">
                        {% if session.group %}
                        <a href="{{ url_for('teacher.group_detail', group_id=session.group.id) }}" style="color: var(--sv-purple); text-decoration: none;">
                            {{ session.group.name }}
                        </a>
                        {% else %}
                        --
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ù…ÙˆØ¹Ø¯</div>
                    <div style="font-weight: 700;">{{ session.scheduled_at|default('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', true) }}</div>
                </div>
                <div>
                    <div class="text-muted text-sm">Ø§Ù„Ù…Ø¯Ø©</div>
                    <div style="font-weight: 700;">{{ session.duration_minutes|default(60) }} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                </div>
                {% if session.recording_url %}
                <div>
                    <div class="text-muted text-sm">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
                    <a href="{{ session.recording_url }}" target="_blank" class="btn btn-sm btn-outline" style="margin-top: var(--space-xs);">
                        Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if session.group %}
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--space-md);">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
            {% set att_all = session.attendance.all() %}
            {% set present_count = att_all|selectattr('status.value', 'equalto', 'present')|list|length %}
            {% set late_count = att_all|selectattr('status.value', 'equalto', 'late')|list|length %}
            {% set absent_count = att_all|selectattr('status.value', 'equalto', 'absent')|list|length %}
            {% set excused_count = att_all|selectattr('status.value', 'equalto', 'excused')|list|length %}
            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="text-sm">Ø­Ø§Ø¶Ø±</span>
                    <span class="badge badge-success">{{ present_count }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="text-sm">Ù…ØªØ£Ø®Ø±</span>
                    <span class="badge badge-warning">{{ late_count }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="text-sm">ØºØ§Ø¦Ø¨</span>
                    <span class="badge badge-danger">{{ absent_count }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="text-sm">Ù…Ø¹ØªØ°Ø±</span>
                    <span class="badge badge-info">{{ excused_count }}</span>
                </div>
            </div>
            {% if att_all %}
            <div style="margin-top: var(--space-md);">
                {% set total_att = att_all|length %}
                {% set attend_rate = ((present_count + late_count) / total_att * 100)|round|int if total_att > 0 else 0 %}
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                    <span class="text-sm text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                    <span class="text-sm" style="font-weight: 700;">{{ attend_rate }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" style="width: {{ attend_rate }}%;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{{ url_for('static', filename='js/teacher.js') }}"></script>
{% endblock %}
