{% extends "base_dashboard.html" %}

{% block page_title %}{{ hw.title|default('ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨') }} - Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teacher.css') }}">
{% endblock %}

{% block sidebar_nav %}
<a href="{{ url_for('teacher.dashboard') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ </span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="{{ url_for('teacher.groups') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ‘¥</span>
    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.sessions') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ“…</span>
    <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.homework') }}" class="sidebar-link active">
    <span class="sidebar-icon">ğŸ“</span>
    <span>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span>
</a>
{% endblock %}

{% block topbar_title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('teacher.homework') }}" class="btn btn-sm btn-ghost">
    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
</a>
{% endblock %}

{% block content %}
<!-- Homework Info -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-purple-glow); color: var(--sv-purple);">ğŸ“</div>
        <div>
            <div class="stat-value text-sm" style="font-size: var(--text-base);">{{ hw.title }}</div>
            <div class="stat-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--info-light); color: var(--info);">ğŸ‘¥</div>
        <div>
            <div class="stat-value text-sm" style="font-size: var(--text-base);">{{ hw.group.name if hw.group else '--' }}</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-orange-glow); color: var(--sv-orange);">ğŸ“¤</div>
        <div>
            <div class="stat-value">{{ submissions|length }}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--success-light); color: var(--success);">âœ…</div>
        <div>
            <div class="stat-value">{{ submissions|selectattr('grade')|list|length }}</div>
            <div class="stat-label">ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ø§</div>
        </div>
    </div>
</div>

{% if hw.description %}
<div class="card" style="margin-bottom: var(--space-xl);">
    <div class="card-header">
        <h2 class="card-title">ÙˆØµÙ Ø§Ù„ÙˆØ§Ø¬Ø¨</h2>
    </div>
    <div style="padding: var(--space-lg);">
        <p style="color: var(--text-secondary); line-height: 1.8;">{{ hw.description }}</p>
    </div>
    {% if hw.due_date %}
    <div style="padding: 0 var(--space-lg) var(--space-lg);">
        <span class="text-sm text-muted">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: {{ hw.due_date }}</span>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Submissions List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</h2>
    </div>

    {% if submissions %}
    <div style="display: flex; flex-direction: column; gap: var(--space-lg); padding: var(--space-lg);">
        {% for sub in submissions %}
        <div style="border: 1px solid var(--border-light); border-radius: var(--radius-lg); overflow: hidden; {% if sub.grade is none %}border-right: 4px solid var(--sv-orange);{% else %}border-right: 4px solid var(--success);{% endif %}">
            <!-- Submission Header -->
            <div style="padding: var(--space-lg); display: flex; align-items: center; justify-content: space-between; background: var(--bg);">
                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                    <div class="avatar avatar-sm">
                        {% if sub.student.avatar_url %}
                        <img src="{{ sub.student.avatar_url }}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                        {% else %}
                        {{ sub.student.name_ar[0] if sub.student.name_ar else '?' }}
                        {% endif %}
                    </div>
                    <div>
                        <a href="{{ url_for('teacher.student_profile', student_id=sub.student.id) }}" style="font-weight: 700; font-size: var(--text-sm); color: var(--text-primary); text-decoration: none;">
                            {{ sub.student.name_ar }}
                        </a>
                        <div class="text-muted" style="font-size: var(--text-xs);">
                            ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…: {{ sub.submitted_at|default('', true) }}
                        </div>
                    </div>
                </div>
                {% if sub.grade is not none %}
                    {% if sub.grade >= 90 %}
                    <span class="badge badge-success">{{ sub.grade }} / 100 (Ù…Ù…ØªØ§Ø²)</span>
                    {% elif sub.grade >= 80 %}
                    <span class="badge badge-success">{{ sub.grade }} / 100 (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹)</span>
                    {% elif sub.grade >= 70 %}
                    <span class="badge badge-info">{{ sub.grade }} / 100 (Ø¬ÙŠØ¯)</span>
                    {% else %}
                    <span class="badge badge-warning">{{ sub.grade }} / 100</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-warning">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                {% endif %}
            </div>

            <!-- Submission Content -->
            {% if sub.content %}
            <div style="padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--border-light);">
                <div class="text-sm text-muted" style="margin-bottom: var(--space-xs); font-weight: 700;">Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</div>
                <div style="background: var(--bg); padding: var(--space-md); border-radius: var(--radius-md); font-size: var(--text-sm); line-height: 1.8; white-space: pre-wrap;">{{ sub.content }}</div>
            </div>
            {% endif %}

            {% if sub.file_url %}
            <div style="padding: var(--space-sm) var(--space-lg);">
                <a href="{{ sub.file_url }}" target="_blank" class="btn btn-sm btn-ghost" style="color: var(--sv-purple);">
                    ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
                </a>
            </div>
            {% endif %}

            <!-- Grade Form / Feedback Display -->
            <div style="padding: var(--space-lg); border-top: 1px solid var(--border-light);">
                {% if sub.grade is none %}
                <form action="{{ url_for('teacher.homework_grade', hw_id=hw.id, submission_id=sub.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div style="display: flex; align-items: flex-end; gap: var(--space-md); flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ù† 100)</label>
                            <input type="number" name="grade" class="form-input" min="0" max="100" placeholder="0-100" required style="width: 120px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨</label>
                            <input type="text" name="feedback" class="form-input" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ø§Ù„Ø¨...">
                        </div>
                        <button type="submit" class="btn btn-sm btn-orange">ØªÙ‚ÙŠÙŠÙ…</button>
                    </div>
                    <div class="form-hint" style="margin-top: var(--space-sm);">
                        Ù†Ù‚Ø§Ø· XP: Ù…Ù…ØªØ§Ø² (90+) = 50 XP | Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ (80+) = 30 XP | Ø¬ÙŠØ¯ (70+) = 20 XP | Ø£Ù‚Ù„ = 10 XP
                    </div>
                </form>
                {% else %}
                <div style="display: flex; align-items: center; gap: var(--space-md); flex-wrap: wrap;">
                    <div>
                        <span class="text-sm text-muted">Ø§Ù„Ø¯Ø±Ø¬Ø©:</span>
                        <span style="font-weight: 700; font-size: var(--text-lg);">{{ sub.grade }} / 100</span>
                    </div>
                    {% if sub.graded_at %}
                    <span class="text-sm text-muted">ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: {{ sub.graded_at }}</span>
                    {% endif %}
                </div>
                {% if sub.feedback %}
                <div style="margin-top: var(--space-sm); padding: var(--space-sm) var(--space-md); background: var(--success-light); border-radius: var(--radius-sm); font-size: var(--text-sm);">
                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> {{ sub.feedback }}
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ù„ÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>
        <p class="text-muted text-sm">Ù„Ù… ÙŠÙ‚Ù… Ø£ÙŠ Ø·Ø§Ù„Ø¨ Ø¨ØªØ³Ù„ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{{ url_for('static', filename='js/teacher.js') }}"></script>
{% endblock %}
