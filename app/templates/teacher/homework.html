{% extends "base_dashboard.html" %}

{% block page_title %}Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª - Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teacher.css') }}">
{% endblock %}

{% block sidebar_nav %}
<a href="{{ url_for('teacher.dashboard') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ </span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="{{ url_for('teacher.groups') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ‘¥</span>
    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.sessions') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ“…</span>
    <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span>
</a>
<a href="{{ url_for('teacher.homework') }}" class="sidebar-link active">
    <span class="sidebar-icon">ğŸ“</span>
    <span>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span>
</a>
{% endblock %}

{% block topbar_title %}Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª{% endblock %}

{% block topbar_actions %}
<button class="btn btn-sm btn-primary" onclick="document.getElementById('newHomeworkModal').classList.add('active')">
    + ÙˆØ§Ø¬Ø¨ Ø¬Ø¯ÙŠØ¯
</button>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-purple-glow); color: var(--sv-purple);">ğŸ“</div>
        <div>
            <div class="stat-value">{{ total|default(0) }}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-orange-glow); color: var(--sv-orange);">ğŸ“¤</div>
        <div>
            <div class="stat-value">
                {% set pending_count = 0 %}
                {% for hw in items %}
                    {% for sub in hw.submissions.all() if sub.grade is none %}
                        {% set pending_count = pending_count + 1 %}
                    {% endfor %}
                {% endfor %}
                {{ pending_count }}
            </div>
            <div class="stat-label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
        </div>
    </div>
</div>

<!-- Homework List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</h2>
    </div>

    {% if items %}
    <div style="display: flex; flex-direction: column; gap: var(--space-lg);">
        {% for hw in items %}
        <div style="border: 1px solid var(--border-light); border-radius: var(--radius-lg); overflow: hidden;">
            <!-- Homework Header -->
            <div style="padding: var(--space-lg); display: flex; align-items: center; justify-content: space-between; background: var(--bg);">
                <div style="flex: 1;">
                    <h3 style="font-weight: 700; font-size: var(--text-lg); margin-bottom: var(--space-xs);">
                        <a href="{{ url_for('teacher.homework_detail', hw_id=hw.id) }}" style="color: var(--text-primary); text-decoration: none;">{{ hw.title }}</a>
                    </h3>
                    <div style="display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
                        <span class="text-sm text-muted">
                            Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:
                            {% if hw.group %}
                            <a href="{{ url_for('teacher.group_detail', group_id=hw.group.id) }}" style="color: var(--sv-purple); text-decoration: none;">{{ hw.group.name }}</a>
                            {% else %}
                            --
                            {% endif %}
                        </span>
                        {% if hw.due_date %}
                        <span class="text-sm text-muted">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: {{ hw.due_date }}</span>
                        {% endif %}
                        <span class="badge badge-purple">{{ hw.submissions.count() }} ØªØ³Ù„ÙŠÙ…</span>
                        {% set ungraded = hw.submissions.filter_by(grade=None).count() %}
                        {% if ungraded > 0 %}
                        <span class="badge badge-warning">{{ ungraded }} Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <a href="{{ url_for('teacher.homework_detail', hw_id=hw.id) }}" class="btn btn-sm btn-primary">Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</a>
                </div>
            </div>

            {% if hw.description %}
            <div style="padding: 0 var(--space-lg); padding-top: var(--space-md);">
                <p class="text-sm" style="color: var(--text-secondary);">{{ hw.description }}</p>
            </div>
            {% endif %}

            <!-- Submissions -->
            {% set subs = hw.submissions.all() %}
            {% if subs %}
            <div style="padding: var(--space-lg);">
                <h4 style="font-weight: 700; font-size: var(--text-sm); margin-bottom: var(--space-md); color: var(--text-secondary);">Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</h4>
                {% for sub in subs %}
                <div class="submission-card">
                    <div class="submission-header">
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <div class="avatar avatar-sm">
                                {% if sub.student.avatar_url %}
                                <img src="{{ sub.student.avatar_url }}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                                {% else %}
                                {{ sub.student.name_ar[0] if sub.student.name_ar else '?' }}
                                {% endif %}
                            </div>
                            <div>
                                <a href="{{ url_for('teacher.student_profile', student_id=sub.student.id) }}" style="font-weight: 700; font-size: var(--text-sm); color: var(--text-primary); text-decoration: none;">
                                    {{ sub.student.name_ar }}
                                </a>
                                <div class="text-muted" style="font-size: var(--text-xs);">{{ sub.submitted_at|default('', true) }}</div>
                            </div>
                        </div>
                        {% if sub.grade is not none %}
                            <span class="badge badge-success">{{ sub.grade }} / 100</span>
                        {% else %}
                            <span class="badge badge-warning">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                        {% endif %}
                    </div>

                    {% if sub.content %}
                    <div class="submission-content">{{ sub.content }}</div>
                    {% endif %}

                    {% if sub.file_url %}
                    <div style="margin-bottom: var(--space-sm);">
                        <a href="{{ sub.file_url }}" target="_blank" class="btn btn-sm btn-ghost" style="color: var(--sv-purple);">
                            ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
                        </a>
                    </div>
                    {% endif %}

                    <!-- Grade Form -->
                    {% if sub.grade is none %}
                    <form action="{{ url_for('teacher.homework_grade', hw_id=hw.id, submission_id=sub.id) }}" method="POST" style="display: flex; align-items: flex-end; gap: var(--space-md); flex-wrap: wrap;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ù† 100)</label>
                            <input type="number" name="grade" class="form-input" min="0" max="100" placeholder="0-100" required style="width: 100px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <input type="text" name="feedback" class="form-input" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ø§Ù„Ø¨...">
                        </div>
                        <button type="submit" class="btn btn-sm btn-orange">ØªÙ‚ÙŠÙŠÙ…</button>
                    </form>
                    {% else %}
                        {% if sub.feedback %}
                        <div style="margin-top: var(--space-sm); padding: var(--space-sm) var(--space-md); background: var(--success-light); border-radius: var(--radius-sm); font-size: var(--text-sm);">
                            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> {{ sub.feedback }}
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="padding: var(--space-lg); text-align: center;">
                <p class="text-muted text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ù„ÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('teacher.homework', page=page-1) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        {% endif %}
        {% for p in range(1, pages + 1) %}
            {% if p == page %}
            <span class="active">{{ p }}</span>
            {% else %}
            <a href="{{ url_for('teacher.homework', page=p) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
        {% if page < pages %}
        <a href="{{ url_for('teacher.homework', page=page+1) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        <p class="text-muted text-sm">Ø£Ù†Ø´Ø¦ ÙˆØ§Ø¬Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù„Ø·Ù„Ø§Ø¨Ùƒ</p>
        <button class="btn btn-primary" onclick="document.getElementById('newHomeworkModal').classList.add('active')" style="margin-top: var(--space-md);">
            + Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
    </div>
    {% endif %}
</div>

<!-- New Homework Modal -->
<div class="modal-overlay" id="newHomeworkModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">ÙˆØ§Ø¬Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <button class="modal-close" onclick="document.getElementById('newHomeworkModal').classList.remove('active')">Ã—</button>
        </div>

        <form action="{{ url_for('teacher.homework_create') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label class="form-label" for="hw_title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨</label>
                <input type="text" class="form-input" id="hw_title" name="title" placeholder="Ù…Ø«Ø§Ù„: ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="hw_group">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
                <select class="form-select" id="hw_group" name="group_id" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="hw_description">Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</label>
                <textarea class="form-textarea" id="hw_description" name="description" rows="4" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="hw_due_date">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
                <input type="datetime-local" class="form-input" id="hw_due_date" name="due_date">
                <div class="form-hint">Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ</div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨</button>
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('newHomeworkModal').classList.remove('active')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{{ url_for('static', filename='js/teacher.js') }}"></script>
{% endblock %}
