{% extends "base_dashboard.html" %}

{% block dashboard_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/student.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/verses-map.css') }}">
{% endblock %}

{% block topbar_title %}{{ unit.name }}{% endblock %}

{% block sidebar_nav %}
<a class="sidebar-link" href="{{ url_for('student.profile') }}">
    <img src="{{ url_for('static', filename='img/sidebar/profile.png') }}" alt="" class="sidebar-icon-img">
    <span>الملف الشخصي</span>
</a>
<a class="sidebar-link" href="{{ url_for('student.dashboard') }}">
    <img src="{{ url_for('static', filename='img/sidebar/home.png') }}" alt="" class="sidebar-icon-img">
    <span>الرئيسية</span>
</a>
<a class="sidebar-link active" href="{{ url_for('student.verses_map') }}">
    <img src="{{ url_for('static', filename='img/sidebar/activities.png') }}" alt="" class="sidebar-icon-img">
    <span>خريطة العوالم</span>
</a>
<a class="sidebar-link" href="{{ url_for('student.quests') }}">
    <img src="{{ url_for('static', filename='img/sidebar/activities.png') }}" alt="" class="sidebar-icon-img">
    <span>المهمات</span>
</a>
<a class="sidebar-link" href="{{ url_for('student.library') }}">
    <img src="{{ url_for('static', filename='img/sidebar/library.png') }}" alt="" class="sidebar-icon-img">
    <span>المكتبة</span>
</a>
<a class="sidebar-link" href="{{ url_for('student.rewards') }}">
    <img src="{{ url_for('static', filename='img/sidebar/rewards.png') }}" alt="" class="sidebar-icon-img">
    <span>المكافآت</span>
</a>
<a class="sidebar-link" href="{{ url_for('student.leaderboard') }}">
    <img src="{{ url_for('static', filename='img/sidebar/landing.png') }}" alt="" class="sidebar-icon-img">
    <span>المتصدرين</span>
</a>
{% endblock %}

{% block content %}

{# Activity type icons #}
{% set type_icons = {
    'coding': '&#x1F4BB;',
    'quiz': '&#x2753;',
    'game': '&#x1F3AE;',
    'reading': '&#x1F4D6;',
    'drag_drop': '&#x1F91A;',
    'project': '&#x1F680;'
} %}

<!-- Back to Adventure Map -->
<a href="{{ url_for('student.verse_adventure', track_id=track.id) }}" class="sv-map-back-btn">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"/>
    </svg>
    خريطة المغامرة
</a>

<!-- Unit Header -->
<div class="sv-unit-header">
    <div class="sv-unit-header-top">
        <div>
            <h1 class="sv-unit-title">{{ unit.name }}</h1>
            <p class="sv-unit-meta">
                {{ level.name_ar if level else '' }} &bull; {{ track.name_ar if track else '' }}
            </p>
        </div>
        {% if progress.status == 'completed' %}
        <span class="sv-unit-badge" style="background: rgba(16,185,129,0.12); color: #059669;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#059669"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            مكتملة
        </span>
        {% else %}
        <span class="sv-unit-badge">
            قيد التقدم
        </span>
        {% endif %}
    </div>
    {% if unit.description %}
    <p style="font-size: 0.85rem; color: var(--text-secondary, #636E72); margin: 0;">{{ unit.description }}</p>
    {% endif %}
</div>

<!-- Activities List -->
{% if unit_activities %}
<div class="sv-section-header">
    <h2 class="sv-section-title">الأنشطة</h2>
    <span style="color: rgba(255,255,255,0.7); font-size: 0.82rem;">
        {% set done_count = student_act_progress.values()|selectattr('status', 'equalto', 'completed')|list|length %}
        {{ done_count }}/{{ unit_activities|length }} مكتمل
    </span>
</div>

<div class="sv-unit-activities-grid">
    {% for activity in unit_activities %}
    {% set sa = student_act_progress.get(activity.id) %}
    {% set is_done = sa and sa.status == 'completed' %}
    <div class="sv-unit-activity-card">
        <div class="sv-unit-activity-icon type-{{ activity.activity_type.value }}">
            {{ type_icons.get(activity.activity_type.value, '&#x1F4DA;')|safe }}
        </div>

        <div class="sv-unit-activity-body">
            <p class="sv-unit-activity-name">{{ activity.title_ar }}</p>
            <div class="sv-unit-activity-rewards">
                <span>&#x26A1; {{ activity.xp_reward }} XP</span>
                <span>&#x1FA99; {{ activity.coin_reward }}</span>
                <span>&#x23F1; {{ activity.estimated_minutes }} د</span>
            </div>
        </div>

        <div class="sv-unit-activity-action">
            {% if is_done %}
            <span class="sv-unit-activity-btn btn-done">&#x2713; مكتمل</span>
            {% elif progress.status != 'completed' %}
            <button class="sv-unit-activity-btn btn-do sv-complete-activity-btn"
                    data-activity-id="{{ activity.id }}"
                    data-xp="{{ activity.xp_reward }}">
                أكمل النشاط
            </button>
            {% else %}
            <span class="sv-unit-activity-btn btn-done" style="opacity: 0.5;">&#x2713;</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="sv-unit-header" style="text-align: center; margin-top: 1rem;">
    <p style="color: var(--text-secondary, #636E72); margin: 0;">لا توجد أنشطة بعد لهذه الوحدة</p>
</div>
{% endif %}

<!-- Lessons Section -->
{% if lessons %}
<div class="sv-section-header" style="margin-top: 2rem;">
    <h2 class="sv-section-title">الدروس</h2>
</div>

<div class="sv-unit-activities-grid">
    {% for lesson in lessons %}
    <a href="{{ url_for('student.lesson_viewer', track_id=track.id, level_id=level.id, unit_id=unit.id) }}"
       class="sv-unit-activity-card" style="text-decoration: none; color: inherit;">
        <div class="sv-unit-activity-icon" style="background: linear-gradient(135deg, #640D5F, #8B1A85);">
            &#x1F4D6;
        </div>
        <div class="sv-unit-activity-body">
            <p class="sv-unit-activity-name">{{ lesson.title_ar }}</p>
            <div class="sv-unit-activity-rewards">
                <span>الفصل {{ lesson.chapter_number }}</span>
            </div>
        </div>
        <div class="sv-unit-activity-action">
            <span class="sv-unit-activity-btn btn-do" style="pointer-events: none;">اقرأ</span>
        </div>
    </a>
    {% endfor %}
</div>
{% endif %}

<!-- Complete Unit Button -->
{% if progress.status == 'current' %}
<div class="sv-complete-unit-wrap">
    <button id="completeUnitBtn" class="sv-complete-unit-btn"
            data-track-id="{{ track.id }}"
            data-level-id="{{ level.id }}"
            data-unit-id="{{ unit.id }}"
            {% if not can_complete_unit %}disabled{% endif %}>
        {% if can_complete_unit %}
        &#x1F3C6; أكمل الوحدة
        {% else %}
        &#x1F512; أكمل جميع الأنشطة أولاً
        {% endif %}
    </button>
</div>
{% elif progress.status == 'completed' %}
<div class="sv-complete-unit-wrap">
    <div style="background: rgba(16,185,129,0.1); border-radius: 16px; padding: 1rem 2rem; display: inline-block;">
        <span style="color: #059669; font-weight: 800; font-size: 1rem;">&#x2705; تم إكمال هذه الوحدة</span>
    </div>
</div>
{% endif %}

<!-- Hidden CSRF token for JS -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

{% endblock %}

{% block dashboard_js %}
<script src="{{ url_for('static', filename='js/gamification.js') }}"></script>
<script src="{{ url_for('static', filename='js/verses-map.js') }}"></script>
{% endblock %}
