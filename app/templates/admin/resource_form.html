{% extends "base_dashboard.html" %}

{% block topbar_title %}{{ 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯' if resource is defined and resource else 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯' }}{% endblock %}

{% block sidebar_nav %}
<a class="sidebar-nav-item" href="{{ url_for('admin.dashboard') }}">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.users') }}">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.groups') }}">ğŸ“š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.sessions') }}">ğŸ“ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</a>
<a class="sidebar-nav-item active" href="{{ url_for('admin.resources') }}">ğŸ“ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.activities') }}">ğŸ® Ø§Ù„Ø£Ù†Ø´Ø·Ø©</a>
<a class="sidebar-nav-item" href="{{ url_for('curriculum.home') }}">ğŸ“– Ø§Ù„Ù…Ù†Ù‡Ø¬</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.reports') }}">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.settings') }}">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
{% endblock %}

{% block dashboard_css %}
<style>
.builder-card {
    position: relative;
    background: rgba(240, 235, 248, 0.6);
    border: 1px solid rgba(180, 140, 210, 0.2);
    border-radius: var(--radius-md);
    padding: 16px;
    padding-top: 20px;
    margin-bottom: 12px;
}
.builder-card .card-num {
    position: absolute; top: -10px; right: 12px;
    background: var(--sv-purple); color: white;
    width: 24px; height: 24px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
}
.builder-card .remove-btn {
    position: absolute; top: 8px; left: 8px;
    background: rgba(214,48,49,0.1); color: #d63031;
    border: none; width: 28px; height: 28px; border-radius: 50%;
    cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
}
.builder-card .remove-btn:hover { background: rgba(214,48,49,0.2); }
.add-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 12px;
    border: 2px dashed rgba(180,140,210,0.3); border-radius: var(--radius-md);
    background: rgba(240,235,248,0.3); color: var(--sv-purple);
    font-family: var(--font-ar); font-size: var(--text-sm); font-weight: 600;
    cursor: pointer; transition: all 0.15s;
}
.add-btn:hover { background: rgba(240,235,248,0.6); border-color: var(--sv-purple); }
.mcq-opt-row { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
.mcq-opt-row .form-input { flex: 1; }
.counter-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 12px; background: var(--sv-orange); color: white;
    border-radius: var(--radius-full); font-size: 12px; font-weight: 700;
}
.type-desc {
    padding: 12px 16px; margin-bottom: 16px;
    background: rgba(235,91,0,0.06); border-right: 3px solid var(--sv-orange);
    border-radius: var(--radius-sm); font-size: var(--text-sm); color: #636E72;
}
.type-desc strong { color: #2D3436; }
</style>
{% endblock dashboard_css %}

{% block content %}
{% set is_edit = resource is defined and resource %}

<div class="card" style="max-width:750px;">
    <form method="POST" enctype="multipart/form-data" id="resourceForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="questions_json" id="questionsJsonInput" value="[]">
        <input type="hidden" name="videos_json" id="videosJsonInput" value="[]">

        <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… (English)</label>
            <input type="text" name="name" class="form-input" value="{{ resource.name if is_edit else '' }}" dir="ltr" required>
        </div>
        <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
            <input type="text" name="name_ar" class="form-input" value="{{ resource.name_ar if is_edit else '' }}" required>
        </div>

        {% if not is_edit %}
        <div class="form-group">
            <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
            <select name="type" id="resourceType" class="form-select" onchange="toggleResourceFields()">
                <option value="slides">Ø´Ø±Ø§Ø¦Ø­ (Slides)</option>
                <option value="code_exercise">ØªÙ…Ø±ÙŠÙ† Ø¨Ø±Ù…Ø¬ÙŠ (Code Exercise)</option>
                <option value="qna">Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø© (Q&A)</option>
                <option value="whiteboard">Ø³Ø¨ÙˆØ±Ø© (Whiteboard)</option>
                <option value="video">ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ (YouTube Video)</option>
                <option value="game">Ù„Ø¹Ø¨Ø© / Ù†Ø´Ø§Ø· (Game / Activity)</option>
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø± <span style="color:var(--status-error);">*</span></label>
            <select name="track_id" class="form-select" required>
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø± â€”</option>
                {% for t in tracks %}
                <option value="{{ t.id }}" {{ 'selected' if is_edit and resource.track_id == t.id else '' }}>{{ t.name_ar }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Type description banner -->
        <div id="typeDesc"></div>

        <!-- ===== SLIDES â€” File Upload ===== -->
        <div id="fields-slides">
            <div class="form-group">
                <label class="form-label">Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¹Ø±Ø¶</label>
                <input type="file" name="file" class="form-input" accept=".pdf,.doc,.docx,.pptx,.png,.jpg,.jpeg,.gif,.webp">
                <div class="form-hint">PDF, PowerPoint Ø£Ùˆ ØµÙˆØ± (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 50 Ù…ÙŠØ¬Ø§)</div>
                {% if is_edit and resource.config_json and '"file_url"' in resource.config_json %}
                <div style="margin-top:var(--space-sm);padding:var(--space-sm);background:var(--success-light);border-radius:var(--radius-md);font-size:var(--text-sm);color:var(--success);">
                    Ù…Ù„Ù Ù…Ø±ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¹Ù†Ø¯ Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯)
                </div>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (JSON)</label>
                <textarea name="config_json" class="form-textarea" rows="3" dir="ltr" placeholder='{"slides_count": 10}'>{{ resource.config_json if is_edit and resource.config_json else '' }}</textarea>
            </div>
        </div>

        <!-- ===== VIDEO â€” Multiple YouTube URLs ===== -->
        <div id="fields-video" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <label class="form-label" style="margin:0;">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨</label>
                <span class="counter-badge" id="videoCount">0 ÙÙŠØ¯ÙŠÙˆ</span>
            </div>
            <div id="videosContainer"></div>
            <button type="button" class="add-btn" onclick="addVideo()">+ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</button>
        </div>

        <!-- ===== QUESTION-BASED TYPES (game, code_exercise, qna) ===== -->
        <div id="fields-questions" style="display:none;">
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                <select name="game_type" id="gameType" class="form-select" onchange="onGameTypeChange()">
                    <option value="mcq">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ (MCQ)</option>
                    <option value="dragdrop">ØªØ±ØªÙŠØ¨ Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª (Drag & Drop)</option>
                    <option value="fillblank">Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§ØºØ§Øª (Fill Blank)</option>
                    <option value="code">ØªØ­Ø¯ÙŠ Ø¨Ø±Ù…Ø¬ÙŠ (Code Challenge)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø´Ø§Ø·</label>
                <input type="text" name="game_title" id="gameTitle" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø¨Ø§ÙŠØ«ÙˆÙ†">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¯Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ (Ø«ÙˆØ§Ù†ÙŠ)</label>
                    <input type="number" name="game_time" id="gameTime" class="form-input" value="60" min="10" max="600" dir="ltr">
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <span class="counter-badge" id="questionCount">0 Ø³Ø¤Ø§Ù„</span>
                </div>
            </div>
            <div id="questionsContainer"></div>
            <button type="button" class="add-btn" id="addQuestionBtn" onclick="addQuestion()">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
        </div>

        <!-- ===== WHITEBOARD â€” No extra fields ===== -->
        <div id="fields-whiteboard" style="display:none;">
            <div style="text-align:center;padding:24px;color:#636E72;">
                <span style="font-size:2.5rem;">ğŸ–Œ</span>
                <p style="margin-top:8px;">Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© â€” Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©.</p>
            </div>
        </div>

        <div style="display:flex;gap:var(--space-md);margin-top:var(--space-lg);">
            <button type="submit" class="btn btn-primary">{{ 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' if is_edit else 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯' }}</button>
            <a href="{{ url_for('admin.resources') }}" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
    </form>
</div>

<script>
var questions = [];
var videos = [];

/* ==========================================
   TYPE DESCRIPTIONS & FIELD TOGGLING
   ========================================== */
var TYPE_INFO = {
    slides:        { desc: '<strong>Ø´Ø±Ø§Ø¦Ø­ Ø¹Ø±Ø¶:</strong> Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ PowerPoint Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø±Ø§Ø¦Ø­ ØªÙØ§Ø¹Ù„ÙŠØ© ÙŠØ¹Ø±Ø¶Ù‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©.', fields: 'slides' },
    code_exercise: { desc: '<strong>ØªÙ…Ø±ÙŠÙ† Ø¨Ø±Ù…Ø¬ÙŠ:</strong> Ø£Ù†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø±Ù…Ø¬ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© â€” Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ ØªØ±ØªÙŠØ¨ ÙƒÙˆØ¯ØŒ Ù…Ù„Ø¡ ÙØ±Ø§ØºØ§ØªØŒ Ø£Ùˆ ØªØ­Ø¯ÙŠ ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯. Ø³ÙŠØ­Ù„Ù‡Ø§ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆÙŠØ­ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ XP.', fields: 'questions', defaultGame: 'code' },
    qna:           { desc: '<strong>Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©:</strong> Ø£Ù†Ø´Ø¦ Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© â€” MCQ Ø£Ùˆ Ù…Ù„Ø¡ ÙØ±Ø§ØºØ§Øª. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙƒØ§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ù†Ø´Ø§Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©.', fields: 'questions', defaultGame: 'mcq' },
    whiteboard:    { desc: '<strong>Ø³Ø¨ÙˆØ±Ø© ØªÙØ§Ø¹Ù„ÙŠØ©:</strong> ÙŠÙØªØ­Ù‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø´Ø±Ø­ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨.', fields: 'whiteboard' },
    video:         { desc: '<strong>ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨:</strong> Ø£Ø¶Ù ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø£ÙƒØ«Ø±. Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ÙŠØ´Ø§Ù‡Ø¯ÙˆÙ† Ø¨Ø§Ù„ØªØ²Ø§Ù…Ù†.', fields: 'video' },
    game:          { desc: '<strong>Ù„Ø¹Ø¨Ø© / Ù†Ø´Ø§Ø·:</strong> Ø£Ù†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© â€” MCQØŒ ØªØ±ØªÙŠØ¨ØŒ Ù…Ù„Ø¡ ÙØ±Ø§ØºØ§ØªØŒ Ø£Ùˆ ÙƒÙˆØ¯. ÙŠÙ„Ø¹Ø¨Ù‡Ø§ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙŠÙƒØ³Ø¨ÙˆÙ† XP.', fields: 'questions', defaultGame: 'mcq' },
};

function toggleResourceFields() {
    var typeEl = document.getElementById('resourceType');
    if (!typeEl) return;
    var val = typeEl.value;
    var info = TYPE_INFO[val] || TYPE_INFO['slides'];

    // Hide all field sections
    ['slides', 'video', 'questions', 'whiteboard'].forEach(function(s) {
        var el = document.getElementById('fields-' + s);
        if (el) el.style.display = 'none';
    });

    // Show the right one
    var target = document.getElementById('fields-' + info.fields);
    if (target) target.style.display = 'block';

    // Update description banner
    document.getElementById('typeDesc').innerHTML = '<div class="type-desc">' + info.desc + '</div>';

    // Set default game type for question-based types
    if (info.fields === 'questions' && info.defaultGame) {
        var gt = document.getElementById('gameType');
        if (gt) gt.value = info.defaultGame;
    }
}

function getGameType() {
    var el = document.getElementById('gameType');
    return el ? el.value : 'mcq';
}

function onGameTypeChange() {
    if (questions.length > 0 && !confirm('ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ø³ÙŠÙ…Ø³Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù…ØªØ£ÙƒØ¯ØŸ')) {
        return;
    }
    questions = [];
    renderQuestions();
}

/* ==========================================
   VIDEO BUILDER
   ========================================== */
function addVideo(url, title) {
    videos.push({ url: url || '', title: title || '' });
    renderVideos();
}

function removeVideo(idx) {
    videos.splice(idx, 1);
    renderVideos();
}

function renderVideos() {
    var c = document.getElementById('videosContainer');
    var h = '';
    videos.forEach(function(v, i) {
        var vid = extractYTId(v.url);
        h += '<div class="builder-card">';
        h += '<span class="card-num">' + (i+1) + '</span>';
        if (videos.length > 1) h += '<button type="button" class="remove-btn" onclick="removeVideo('+i+')">Ã—</button>';
        h += '<div class="form-group" style="margin-bottom:8px;"><label class="form-label" style="font-size:12px;">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>';
        h += '<input type="text" class="form-input" value="'+esc(v.title)+'" placeholder="ÙÙŠØ¯ÙŠÙˆ '+(i+1)+'" oninput="videos['+i+'].title=this.value"></div>';
        h += '<div class="form-group" style="margin-bottom:8px;"><label class="form-label" style="font-size:12px;">Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨</label>';
        h += '<input type="url" class="form-input" dir="ltr" value="'+esc(v.url)+'" placeholder="https://www.youtube.com/watch?v=..." oninput="videos['+i+'].url=this.value;renderVideos()"></div>';
        if (vid) h += '<div style="border-radius:var(--radius-md);overflow:hidden;"><iframe width="100%" height="200" src="https://www.youtube.com/embed/'+vid+'" style="border:none;" allowfullscreen></iframe></div>';
        h += '</div>';
    });
    c.innerHTML = h;
    document.getElementById('videoCount').textContent = videos.length + ' ÙÙŠØ¯ÙŠÙˆ';
}

function extractYTId(url) {
    if (!url) return null;
    var m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
    return m ? m[1] : null;
}

/* ==========================================
   QUESTION BUILDER
   ========================================== */
function addQuestion() {
    var type = getGameType();
    var q = { type: type };
    if (type === 'mcq')       { q.question=''; q.options=['','','','']; q.correct=0; }
    else if (type === 'dragdrop')  { q.instruction=''; q.items=['','','','']; q.correctOrder=[0,1,2,3]; }
    else if (type === 'fillblank') { q.lines=[{text:'',blanks:[{answer:''}]}]; }
    else if (type === 'code')      { q.instructions=''; q.starterCode=''; }
    questions.push(q);
    renderQuestions();
    var cards = document.querySelectorAll('#questionsContainer .builder-card');
    if (cards.length) cards[cards.length-1].scrollIntoView({behavior:'smooth',block:'center'});
}

function removeQuestion(idx) { questions.splice(idx,1); renderQuestions(); }

function renderQuestions() {
    var c = document.getElementById('questionsContainer');
    var type = getGameType();
    var h = '';
    questions.forEach(function(q,i) {
        h += '<div class="builder-card"><span class="card-num">'+(i+1)+'</span>';
        if (questions.length > 1) h += '<button type="button" class="remove-btn" onclick="removeQuestion('+i+')">Ã—</button>';
        if (type==='mcq')           h += renderMCQ(q,i);
        else if (type==='dragdrop') h += renderDragDrop(q,i);
        else if (type==='fillblank') h += renderFillBlank(q,i);
        else if (type==='code')     h += renderCode(q,i);
        h += '</div>';
    });
    c.innerHTML = h;
    document.getElementById('questionCount').textContent = questions.length + ' Ø³Ø¤Ø§Ù„';
    var labels = {mcq:'+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ MCQ', dragdrop:'+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ØªØ±ØªÙŠØ¨', fillblank:'+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙØ±Ø§ØºØ§Øª', code:'+ Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠ Ø¨Ø±Ù…Ø¬ÙŠ'};
    document.getElementById('addQuestionBtn').textContent = labels[type] || '+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„';
}

/* --- MCQ --- */
function renderMCQ(q, qi) {
    var h = '<div class="form-group" style="margin-bottom:10px;"><label class="form-label" style="font-size:12px;">Ø§Ù„Ø³Ø¤Ø§Ù„</label>';
    h += '<input type="text" class="form-input" value="'+esc(q.question)+'" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." oninput="questions['+qi+'].question=this.value"></div>';
    h += '<div class="form-group" style="margin-bottom:6px;"><label class="form-label" style="font-size:12px;">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª <span style="color:#636E72;font-weight:400;">(Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­Ø©)</span></label>';
    q.options.forEach(function(opt,oi) {
        h += '<div class="mcq-opt-row">';
        h += '<input type="radio" name="q'+qi+'_c" value="'+oi+'" '+(q.correct===oi?'checked':'')+' onchange="questions['+qi+'].correct='+oi+'">';
        h += '<input type="text" class="form-input" value="'+esc(opt)+'" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± '+(oi+1)+'" oninput="questions['+qi+'].options['+oi+']=this.value">';
        if (q.options.length > 2) h += '<button type="button" style="background:none;border:none;color:#d63031;cursor:pointer;font-size:18px;padding:0 4px;" onclick="rmMcqOpt('+qi+','+oi+')">Ã—</button>';
        h += '</div>';
    });
    if (q.options.length < 6) h += '<button type="button" style="background:none;border:1px dashed rgba(180,140,210,0.3);border-radius:var(--radius-sm);padding:6px 12px;color:var(--sv-purple);font-size:12px;cursor:pointer;font-family:var(--font-ar);width:100%;" onclick="addMcqOpt('+qi+')">+ Ø®ÙŠØ§Ø± Ø¥Ø¶Ø§ÙÙŠ</button>';
    h += '</div>';
    return h;
}
function addMcqOpt(qi) { questions[qi].options.push(''); renderQuestions(); }
function rmMcqOpt(qi,oi) { questions[qi].options.splice(oi,1); if(questions[qi].correct>=questions[qi].options.length) questions[qi].correct=0; renderQuestions(); }

/* --- Drag & Drop --- */
function renderDragDrop(q, qi) {
    var h = '<div class="form-group" style="margin-bottom:10px;"><label class="form-label" style="font-size:12px;">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</label>';
    h += '<input type="text" class="form-input" value="'+esc(q.instruction||'')+'" placeholder="Ø±ØªØ¨ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­" oninput="questions['+qi+'].instruction=this.value"></div>';
    h += '<div class="form-group" style="margin-bottom:6px;"><label class="form-label" style="font-size:12px;">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ <span style="color:#636E72;font-weight:400;">(ØªÙØ®Ù„Ø· Ù„Ù„Ø·Ø§Ù„Ø¨)</span></label>';
    q.items.forEach(function(item,ii) {
        h += '<div style="display:flex;gap:8px;margin-bottom:6px;align-items:center;">';
        h += '<span style="color:#636E72;font-size:12px;width:20px;text-align:center;">'+(ii+1)+'</span>';
        h += '<input type="text" class="form-input" dir="ltr" value="'+esc(item)+'" placeholder="Ø§Ù„Ø¹Ù†ØµØ± '+(ii+1)+'" oninput="questions['+qi+'].items['+ii+']=this.value" style="flex:1;">';
        if (q.items.length > 2) h += '<button type="button" style="background:none;border:none;color:#d63031;cursor:pointer;font-size:18px;padding:0 4px;" onclick="rmDragItem('+qi+','+ii+')">Ã—</button>';
        h += '</div>';
    });
    if (q.items.length < 10) h += '<button type="button" style="background:none;border:1px dashed rgba(180,140,210,0.3);border-radius:var(--radius-sm);padding:6px 12px;color:var(--sv-purple);font-size:12px;cursor:pointer;font-family:var(--font-ar);width:100%;" onclick="addDragItem('+qi+')">+ Ø¹Ù†ØµØ± Ø¥Ø¶Ø§ÙÙŠ</button>';
    h += '</div>';
    return h;
}
function addDragItem(qi) { questions[qi].items.push(''); questions[qi].correctOrder.push(questions[qi].items.length-1); renderQuestions(); }
function rmDragItem(qi,ii) { questions[qi].items.splice(ii,1); questions[qi].correctOrder=questions[qi].items.map(function(_,i){return i;}); renderQuestions(); }

/* --- Fill Blank --- */
function renderFillBlank(q, qi) {
    var h = '<div class="form-group" style="margin-bottom:6px;"><label class="form-label" style="font-size:12px;">Ø£Ø³Ø·Ø± Ø§Ù„ÙƒÙˆØ¯ <span style="color:#636E72;font-weight:400;">(Ø§Ø³ØªØ®Ø¯Ù… ___ Ù„Ù„ÙØ±Ø§Øº)</span></label>';
    q.lines.forEach(function(line,li) {
        h += '<div style="display:flex;gap:8px;margin-bottom:6px;align-items:center;">';
        h += '<span style="color:#636E72;font-size:11px;width:20px;text-align:center;">'+(li+1)+'</span>';
        h += '<input type="text" class="form-input" dir="ltr" value="'+esc(line.text)+'" placeholder="x = ___ + 2" oninput="updFillLine('+qi+','+li+',this.value)" style="flex:1;font-family:var(--font-mono);font-size:13px;">';
        if (q.lines.length > 1) h += '<button type="button" style="background:none;border:none;color:#d63031;cursor:pointer;font-size:18px;padding:0 4px;" onclick="rmFillLine('+qi+','+li+')">Ã—</button>';
        h += '</div>';
        if (line.blanks && line.blanks.length) {
            line.blanks.forEach(function(b,bi) {
                h += '<div style="display:flex;gap:8px;margin-bottom:4px;margin-right:28px;align-items:center;">';
                h += '<span style="color:var(--sv-orange);font-size:11px;">Ø¥Ø¬Ø§Ø¨Ø© '+(bi+1)+':</span>';
                h += '<input type="text" class="form-input" dir="ltr" value="'+esc(b.answer)+'" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" oninput="questions['+qi+'].lines['+li+'].blanks['+bi+'].answer=this.value" style="flex:1;max-width:200px;font-family:var(--font-mono);">';
                h += '</div>';
            });
        }
    });
    h += '<button type="button" style="background:none;border:1px dashed rgba(180,140,210,0.3);border-radius:var(--radius-sm);padding:6px 12px;color:var(--sv-purple);font-size:12px;cursor:pointer;font-family:var(--font-ar);width:100%;" onclick="addFillLine('+qi+')">+ Ø³Ø·Ø± Ø¥Ø¶Ø§ÙÙŠ</button>';
    h += '</div>';
    return h;
}
function updFillLine(qi,li,text) {
    questions[qi].lines[li].text = text;
    var n = (text.match(/___/g)||[]).length;
    var b = questions[qi].lines[li].blanks || [];
    while(b.length < n) b.push({answer:''});
    while(b.length > n) b.pop();
    questions[qi].lines[li].blanks = n ? b : [];
    renderQuestions();
}
function addFillLine(qi) { questions[qi].lines.push({text:'',blanks:[]}); renderQuestions(); }
function rmFillLine(qi,li) { questions[qi].lines.splice(li,1); renderQuestions(); }

/* --- Code Challenge --- */
function renderCode(q, qi) {
    var h = '<div class="form-group" style="margin-bottom:10px;"><label class="form-label" style="font-size:12px;">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</label>';
    h += '<textarea class="form-textarea" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø¯Ø§Ù„Ø© ØªØ­Ø³Ø¨..." oninput="questions['+qi+'].instructions=this.value">'+esc(q.instructions||'')+'</textarea></div>';
    h += '<div class="form-group"><label class="form-label" style="font-size:12px;">ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>';
    h += '<textarea class="form-textarea" rows="4" dir="ltr" style="font-family:var(--font-mono);font-size:13px;" placeholder="def solve():&#10;    pass" oninput="questions['+qi+'].starterCode=this.value">'+esc(q.starterCode||'')+'</textarea></div>';
    return h;
}

/* --- Helpers --- */
function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }

/* --- Submit: serialize --- */
document.getElementById('resourceForm').addEventListener('submit', function() {
    document.getElementById('questionsJsonInput').value = JSON.stringify(questions);
    document.getElementById('videosJsonInput').value = JSON.stringify(videos);
});

/* ==========================================
   INIT
   ========================================== */
{% if is_edit %}
    {% if resource.type.value == 'video' %}
        document.getElementById('fields-slides').style.display = 'none';
        document.getElementById('fields-video').style.display = 'block';
        document.getElementById('typeDesc').innerHTML = '<div class="type-desc">' + TYPE_INFO.video.desc + '</div>';
        try {
            var cfg = JSON.parse({{ resource.config_json | default('"{}"', true) | tojson }});
            if (cfg.videos && cfg.videos.length) { cfg.videos.forEach(function(v){videos.push(v);}); }
            else if (cfg.youtube_url) { videos.push({url:cfg.youtube_url,title:''}); }
            renderVideos();
        } catch(e) {}
    {% elif resource.type.value in ('game','code_exercise','qna') %}
        document.getElementById('fields-slides').style.display = 'none';
        document.getElementById('fields-questions').style.display = 'block';
        document.getElementById('typeDesc').innerHTML = '<div class="type-desc">' + TYPE_INFO['{{ resource.type.value }}'].desc + '</div>';
        try {
            var cfg = JSON.parse({{ resource.config_json | default('"{}"', true) | tojson }});
            if (cfg.activity) {
                var a = cfg.activity;
                if (document.getElementById('gameType')) document.getElementById('gameType').value = a.type || 'mcq';
                if (document.getElementById('gameTitle')) document.getElementById('gameTitle').value = a.title || '';
                if (document.getElementById('gameTime')) document.getElementById('gameTime').value = a.timeLimit || 60;
                if (a.questions && a.questions.length) { questions = a.questions; }
                else {
                    var q = {type:a.type};
                    if (a.type==='mcq') {q.question=a.question||'';q.options=a.options||[];q.correct=a.correct||0;}
                    else if (a.type==='dragdrop') {q.instruction='';q.items=a.items||[];q.correctOrder=a.correctOrder||[];}
                    else if (a.type==='fillblank') {q.lines=a.lines||[];}
                    else if (a.type==='code') {q.instructions=a.instructions||'';q.starterCode=a.starterCode||'';}
                    questions = [q];
                }
                renderQuestions();
            }
        } catch(e) {}
    {% elif resource.type.value == 'whiteboard' %}
        document.getElementById('fields-slides').style.display = 'none';
        document.getElementById('fields-whiteboard').style.display = 'block';
        document.getElementById('typeDesc').innerHTML = '<div class="type-desc">' + TYPE_INFO.whiteboard.desc + '</div>';
    {% else %}
        document.getElementById('typeDesc').innerHTML = '<div class="type-desc">' + TYPE_INFO.slides.desc + '</div>';
    {% endif %}
{% else %}
    toggleResourceFields();
{% endif %}
</script>
{% endblock %}
