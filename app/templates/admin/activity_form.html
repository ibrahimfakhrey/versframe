{% extends "base_dashboard.html" %}

{% set is_edit = activity is defined and activity %}

{% block topbar_title %}{{ 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·' if is_edit else 'Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯' }}{% endblock %}

{% block sidebar_nav %}
<a class="sidebar-nav-item" href="{{ url_for('admin.dashboard') }}">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.users') }}">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.groups') }}">ğŸ“š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.sessions') }}">ğŸ“ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.resources') }}">ğŸ“ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</a>
<a class="sidebar-nav-item active" href="{{ url_for('admin.activities') }}">ğŸ® Ø§Ù„Ø£Ù†Ø´Ø·Ø©</a>
<a class="sidebar-nav-item" href="{{ url_for('curriculum.home') }}">ğŸ“– Ø§Ù„Ù…Ù†Ù‡Ø¬</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.reports') }}">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
<a class="sidebar-nav-item" href="{{ url_for('admin.settings') }}">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
{% endblock %}

{% block content %}
<div class="card" style="max-width:700px;">
    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Title AR -->
        <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© <span style="color:var(--status-error);">*</span></label>
            <input type="text" name="title_ar" class="form-input" value="{{ activity.title_ar if is_edit else '' }}" required placeholder="Ù…Ø«Ø§Ù„: ØªÙ…Ø±ÙŠÙ† Ø¨Ø±Ù…Ø¬ÙŠ: Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª">
        </div>

        <!-- Title EN -->
        <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
            <input type="text" name="title" class="form-input" value="{{ activity.title if is_edit else '' }}" dir="ltr" placeholder="e.g. Coding Exercise: Variables">
        </div>

        <!-- Type + Source + Difficulty Row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--space-md);">
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù†ÙˆØ¹ <span style="color:var(--status-error);">*</span></label>
                <select name="activity_type" class="form-select">
                    {% set cur_type = activity.activity_type.value if is_edit else 'coding' %}
                    <option value="coding" {{ 'selected' if cur_type=='coding' }}>ğŸ’» Ø¨Ø±Ù…Ø¬Ø©</option>
                    <option value="quiz" {{ 'selected' if cur_type=='quiz' }}>â“ Ø§Ø®ØªØ¨Ø§Ø±</option>
                    <option value="game" {{ 'selected' if cur_type=='game' }}>ğŸ® Ù„Ø¹Ø¨Ø©</option>
                    <option value="drag_drop" {{ 'selected' if cur_type=='drag_drop' }}>ğŸ¤š Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª</option>
                    <option value="reading" {{ 'selected' if cur_type=='reading' }}>ğŸ“– Ù‚Ø±Ø§Ø¡Ø©</option>
                    <option value="project" {{ 'selected' if cur_type=='project' }}>ğŸš€ Ù…Ø´Ø±ÙˆØ¹</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…ØµØ¯Ø±</label>
                <select name="source" class="form-select">
                    {% set cur_source = activity.source.value if is_edit else 'self_paced' %}
                    <option value="self_paced" {{ 'selected' if cur_source=='self_paced' }}>Ø°Ø§ØªÙŠ</option>
                    <option value="assigned" {{ 'selected' if cur_source=='assigned' }}>Ù…Ø¹ÙŠÙ‘Ù†</option>
                    <option value="live_class" {{ 'selected' if cur_source=='live_class' }}>ÙØµÙ„ Ù…Ø¨Ø§Ø´Ø±</option>
                    <option value="quest" {{ 'selected' if cur_source=='quest' }}>Ù…Ù‡Ù…Ø©</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                <select name="difficulty" class="form-select">
                    {% set cur_diff = activity.difficulty.value if is_edit else 'beginner' %}
                    <option value="beginner" {{ 'selected' if cur_diff=='beginner' }}>Ù…Ø¨ØªØ¯Ø¦</option>
                    <option value="intermediate" {{ 'selected' if cur_diff=='intermediate' }}>Ù…ØªÙˆØ³Ø·</option>
                    <option value="advanced" {{ 'selected' if cur_diff=='advanced' }}>Ù…ØªÙ‚Ø¯Ù…</option>
                </select>
            </div>
        </div>

        <!-- Track / Level / Unit Cascading Selects -->
        <div style="background:#F8F6FC;border-radius:var(--radius-md);padding:var(--space-md);margin-bottom:var(--space-md);border:1px solid rgba(100,13,95,0.08);">
            <div style="font-weight:700;font-size:var(--text-sm);margin-bottom:var(--space-sm);color:var(--sv-purple,#640D5F);">Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ù†Ù‡Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>

            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--space-md);">
                <div class="form-group" style="margin-bottom:0;">
                    <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø±</label>
                    <select name="track_id" id="trackSelect" class="form-select" onchange="onTrackChange(this.value)">
                        <option value="">â€” Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§Ø± â€”</option>
                        {% for t in tracks %}
                        <option value="{{ t.id }}" {{ 'selected' if is_edit and activity.track_id == t.id }}>{{ t.name_ar }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                    <select name="level_id" id="levelSelect" class="form-select" onchange="onLevelChange(this.value)">
                        <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ â€”</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <select name="unit_id" id="unitSelect" class="form-select">
                        <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹ â€”</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Rewards Row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:var(--space-md);">
            <div class="form-group">
                <label class="form-label">Ù…ÙƒØ§ÙØ£Ø© XP</label>
                <input type="number" name="xp_reward" class="form-input" value="{{ activity.xp_reward if is_edit else 20 }}" min="0" max="500">
            </div>
            <div class="form-group">
                <label class="form-label">Ù…ÙƒØ§ÙØ£Ø© Ø¹Ù…Ù„Ø§Øª</label>
                <input type="number" name="coin_reward" class="form-input" value="{{ activity.coin_reward if is_edit else 10 }}" min="0" max="500">
            </div>
            <div class="form-group">
                <label class="form-label">Ø§Ù„ÙˆÙ‚Øª (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                <input type="number" name="estimated_minutes" class="form-input" value="{{ activity.estimated_minutes if is_edit else 10 }}" min="1" max="120">
            </div>
            <div class="form-group">
                <label class="form-label">ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶</label>
                <input type="number" name="sort_order" class="form-input" value="{{ activity.sort_order if is_edit else 0 }}" min="0">
            </div>
        </div>

        <!-- Submit -->
        <div style="display:flex;gap:var(--space-md);margin-top:var(--space-md);">
            <button type="submit" class="btn btn-primary">{{ 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' if is_edit else 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·' }}</button>
            <a href="{{ url_for('admin.activities') }}" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
    </form>
</div>

<script>
// Cascading Track â†’ Level â†’ Unit selects
var levelsData = {};

function onTrackChange(trackId) {
    var levelSelect = document.getElementById('levelSelect');
    var unitSelect = document.getElementById('unitSelect');
    levelSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ â€”</option>';
    unitSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹ â€”</option>';

    if (!trackId) return;

    fetch('/admin/api/levels/' + trackId)
        .then(function(r) { return r.json(); })
        .then(function(levels) {
            levelsData = {};
            levels.forEach(function(lvl) {
                levelsData[lvl.id] = lvl.units;
                var opt = document.createElement('option');
                opt.value = lvl.id;
                opt.textContent = lvl.name_ar;
                levelSelect.appendChild(opt);
            });

            // If editing, pre-select current level
            {% if is_edit and activity.level_id %}
            levelSelect.value = '{{ activity.level_id }}';
            onLevelChange('{{ activity.level_id }}');
            {% endif %}
        });
}

function onLevelChange(levelId) {
    var unitSelect = document.getElementById('unitSelect');
    unitSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© â€”</option>';

    if (!levelId || !levelsData[levelId]) return;

    levelsData[levelId].forEach(function(u) {
        var opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.name + (u.name_en ? ' (' + u.name_en + ')' : '');
        unitSelect.appendChild(opt);
    });

    // If editing, pre-select current unit
    {% if is_edit and activity.unit_id %}
    unitSelect.value = '{{ activity.unit_id }}';
    {% endif %}
}

// On page load, trigger cascade if track is already selected
document.addEventListener('DOMContentLoaded', function() {
    var trackSelect = document.getElementById('trackSelect');
    if (trackSelect.value) {
        onTrackChange(trackSelect.value);
    }
});
</script>
{% endblock %}
