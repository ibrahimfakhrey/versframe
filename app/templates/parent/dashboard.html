{% extends "base_dashboard.html" %}

{% block title %}Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±{% endblock %}
{% block topbar_title %}Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±{% endblock %}

{% block sidebar_nav %}
<a href="{{ url_for('parent.dashboard') }}" class="sidebar-link active">
    <span class="sidebar-icon">ğŸ </span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="{{ url_for('parent.children') }}" class="sidebar-link">
    <span class="sidebar-icon">ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦</span>
    <span>Ø£Ø¨Ù†Ø§Ø¦ÙŠ</span>
</a>
<a href="{{ url_for('parent.messages') }}" class="sidebar-link">
    <span class="sidebar-icon">âœ‰ï¸</span>
    <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
</a>
{% endblock %}

{% block content %}
<!-- ØªØ±Ø­ÙŠØ¨ -->
<div class="page-header">
    <h2 class="page-title">Ù…Ø±Ø­Ø¨Ø§ØŒ {{ current_user.name_ar }} ğŸ‘‹</h2>
    <p class="page-subtitle">ØªØ§Ø¨Ø¹ ØªÙ‚Ø¯Ù… Ø£Ø¨Ù†Ø§Ø¦Ùƒ ÙÙŠ Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³</p>
</div>

<!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-purple-glow); color: var(--sv-purple);">ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦</div>
        <div>
            <div class="stat-value">{{ children|length }}</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--sv-orange-glow); color: var(--sv-orange);">ğŸ“…</div>
        <div>
            <div class="stat-value">
                {% set total_upcoming = namespace(count=0) %}
                {% for child in children %}
                    {% if children_data.get(child.id) %}
                        {% set total_upcoming.count = total_upcoming.count + children_data[child.id].upcoming_sessions_count %}
                    {% endif %}
                {% endfor %}
                {{ total_upcoming.count }}
            </div>
            <div class="stat-label">Ø§Ù„Ø­ØµØµ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--success-light); color: var(--success);">âš¡</div>
        <div>
            <div class="stat-value">
                {% set total_xp = namespace(sum=0) %}
                {% for child in children %}
                    {% if children_data.get(child.id) %}
                        {% set total_xp.sum = total_xp.sum + children_data[child.id].xp %}
                    {% endif %}
                {% endfor %}
                {{ total_xp.sum }}
            </div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ XP</div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon" style="background: var(--info-light); color: var(--info);">ğŸ”¥</div>
        <div>
            <div class="stat-value">
                {% set max_streak = namespace(val=0) %}
                {% for child in children %}
                    {% if children_data.get(child.id) and children_data[child.id].streak > max_streak.val %}
                        {% set max_streak.val = children_data[child.id].streak %}
                    {% endif %}
                {% endfor %}
                {{ max_streak.val }}
            </div>
            <div class="stat-label">Ø£Ø¹Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© Ø£ÙŠØ§Ù…</div>
        </div>
    </div>
</div>

<!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ -->
<div class="page-header" style="margin-top: var(--space-xl);">
    <h3 class="card-title">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</h3>
</div>

{% if children %}
<div class="children-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: var(--space-md);">
    {% for child in children %}
    {% set data = children_data.get(child.id, {}) %}
    <div class="card" style="cursor: pointer;" onclick="location.href='{{ url_for('parent.child_detail', child_id=child.id) }}'">
        <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
            <div class="avatar avatar-lg" style="background: linear-gradient(135deg, var(--sv-purple), var(--sv-orange)); color: white;">
                {% if child.avatar_url %}
                <img src="{{ child.avatar_url }}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                {% else %}
                {{ child.name_ar[0] if child.name_ar else '?' }}
                {% endif %}
            </div>
            <div style="flex:1;">
                <div style="font-weight: var(--fw-bold); font-size: var(--text-lg);">{{ child.name_ar }}</div>
                <div style="color: var(--text-secondary); font-size: var(--text-sm);">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ data.get('level', 1) }}</div>
            </div>
            <span class="badge badge-purple">{{ data.get('xp', 0) }} XP</span>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div style="margin-bottom: var(--space-md);">
            <div style="display: flex; justify-content: space-between; font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: var(--space-xs);">
                <span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ data.get('level', 1) }}</span>
                <span>{{ data.get('xp', 0) }} XP</span>
            </div>
            <div class="progress">
                <div class="progress-bar" style="width: {{ ((data.get('xp', 0) % 100) if data.get('xp', 0) else 0) }}%;"></div>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
        <div style="display: flex; justify-content: space-around; text-align: center; padding-top: var(--space-md); border-top: 1px solid var(--border-light);">
            <div>
                <div style="font-size: var(--text-lg); font-weight: var(--fw-bold); color: var(--sv-orange);">ğŸ”¥ {{ data.get('streak', 0) }}</div>
                <div style="font-size: var(--text-xs); color: var(--text-secondary);">Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£ÙŠØ§Ù…</div>
            </div>
            <div>
                <div style="font-size: var(--text-lg); font-weight: var(--fw-bold); color: var(--sv-purple);">ğŸ“… {{ data.get('upcoming_sessions_count', 0) }}</div>
                <div style="font-size: var(--text-xs); color: var(--text-secondary);">Ø­ØµØµ Ù‚Ø§Ø¯Ù…Ø©</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card empty-state">
    <div class="empty-state-icon">ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦</div>
    <div class="empty-state-text">Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø· Ø£ÙŠ Ø£Ø¨Ù†Ø§Ø¡ Ø¨Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø¹Ø¯</div>
    <p style="color: var(--text-muted); font-size: var(--text-sm);">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø´Ù„Ø¨ÙŠ ÙÙŠØ±Ø³ Ù„Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ø¨Ù†Ø§Ø¦Ùƒ</p>
</div>
{% endif %}
{% endblock %}
